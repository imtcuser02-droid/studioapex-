<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cartier | The Panthère Odyssey</title>
    <style>
        :root { 
            --cartier-red: #801B2B; 
            --gold: #c5a059; 
            --white: #ffffff; 
            --black: #000000; 
        }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--black); font-family: "Times New Roman", serif; overflow: hidden; color: white; touch-action: manipulation; }

        /* HUD */
        #hud { position: fixed; top: 20px; left: 20px; color: var(--gold); z-index: 100; letter-spacing: 3px; font-size: 12px; display: none; }
        .game-level { display: none; width: 100vw; height: 100vh; position: relative; flex-direction: column; align-items: center; justify-content: center; transition: background 0.5s ease; }
        .active { display: flex; }

        video { height: 75vh; width: auto; max-width: 90vw; transition: filter 0.2s; z-index: 2; }

        /* Level 1 Specific: Full Background Video */
        #level-1 video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; }
        #canvas-l1 { position: absolute; top: 0; left: 0; z-index: 10; cursor: crosshair; touch-action: none; }

        /* Level 2: Slow & Smooth Run Hunt */
        #level-2 { background: var(--cartier-red) !important; cursor: none; }
        #v2-container { 
            position: absolute; 
            width: 120px; 
            height: 120px; 
            overflow: hidden; 
            border-radius: 50%; 
            border: 1px solid var(--white); 
            cursor: pointer; 
            z-index: 20; 
            display: none; 
            filter: brightness(0); 
            transition: filter 0.2s ease, left 1.5s ease-in-out, top 1.5s ease-in-out;
        }
        #v2-container video { height: 120px; width: auto; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); }
        
        #spot-mask { 
            position: absolute; 
            inset: 0; 
            background: radial-gradient(circle 100px at var(--x) var(--y), transparent 20%, rgba(128, 27, 43, 0.95) 100%); 
            z-index: 15; 
            pointer-events: none; 
            transition: background 0.05s linear; 
        }

        /* Level 3: Full Screen Immersive UI */
        #level-3 { background: var(--cartier-red); }
        #v3-fullscreen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; display: none; }
        .l3-ui-overlay { z-index: 10; text-align: center; width: 100%; }
        .input-display { font-size: 24px; color: var(--white); letter-spacing: 5px; margin: 20px; height: 40px; text-transform: uppercase; }
        
        /* Level 3 Choice Menu */
        #l3-choice-menu { position: absolute; inset: 0; background: rgba(0,0,0,0.8); z-index: 50; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .choice-btn { margin: 10px; padding: 12px 30px; border: 1px solid var(--gold); color: var(--gold); background: none; cursor: pointer; text-transform: uppercase; letter-spacing: 2px; transition: 0.3s; font-size: 12px; }
        .choice-btn:hover { background: var(--gold); color: black; }

        /* Level 4: Petting */
        #pet-zone { position: absolute; width: 100%; height: 60%; z-index: 30; cursor: pointer; touch-action: none; }
        .purr-meter { width: 70%; max-width: 300px; height: 6px; background: rgba(255,255,255,0.1); margin-top: 20px; border-radius: 10px; overflow: hidden; z-index: 10; }
        #purr-fill { width: 0%; height: 100%; background: var(--gold); }

        /* Level 5: Puzzle */
        #level-5 { background: var(--white) !important; color: var(--cartier-red); }
        #puzzle-board { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            grid-template-rows: repeat(3, 1fr); 
            width: 90vw; 
            height: 90vw; 
            max-width: 500px;
            max-height: 500px;
            gap: 2px; 
            background: var(--cartier-red); 
            border: 4px solid var(--cartier-red); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .tile { position: relative; overflow: hidden; cursor: pointer; background: var(--white); }
        .tile video { position: absolute; width: 300%; height: 300%; pointer-events: none; }
        .tile.selected { outline: 3px solid var(--cartier-red); z-index: 10; }
        .puzzle-text { margin-top: 20px; letter-spacing: 2px; text-transform: uppercase; font-size: 12px; color: var(--cartier-red); font-weight: bold; }

        /* Mobile specific HUD adjustment */
        @media (max-width: 600px) {
            video { height: auto; width: 90vw; }
            #start-gate h1 { font-size: 40px !important; }
            .input-display { font-size: 18px; }
        }

        /* Gates */
        #start-gate { 
            position: fixed; inset: 0; z-index: 1000; 
            display: flex; justify-content: center; align-items: center; 
            background-color: var(--cartier-red); 
            background-image: url('logo.jpeg');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            cursor: pointer; 
        }
        
        #btn-gate { position: fixed; inset: 0; z-index: 1000; display: none; flex-direction: column; justify-content: center; align-items: center; background: var(--black); }
        .start-btn { padding: 15px 40px; border: 1px solid var(--gold); color: var(--gold); background: none; cursor: pointer; text-transform: uppercase; letter-spacing: 3px; transition: 0.3s; font-size: 14px; }
        .start-btn:hover { background: var(--gold); color: black; }
        #end-page { position: fixed; inset: 0; z-index: 1000; display: none; flex-direction: column; justify-content: center; align-items: center; background: var(--cartier-red); color: white; text-align: center; }
    </style>
</head>
<body>

<div id="start-gate" onclick="showStartButton()"></div>

<div id="btn-gate"><button class="start-btn" onclick="nextLevel()">Play with the Panthère</button></div>
<div id="hud">GAME: <span id="lvl-num">1</span>/5</div>

<div class="game-level" id="level-1">
    <video playsinline muted autoplay loop><source src="standing.mp4" type="video/mp4"></video>
    <canvas id="canvas-l1"></canvas>
    <button style="display:none; position:absolute; bottom:50px; z-index:50;" id="n1" onclick="nextLevel()" class="start-btn">Enter Boutique</button>
</div>

<div class="game-level" id="level-2">
    <div id="spot-mask"></div>
    <div id="v2-container" onclick="catchPanther()">
        <video playsinline muted autoplay loop><source src="jumping.mp4" type="video/mp4"></video>
    </div>
    <div id="l2-text" style="color: var(--white); z-index: 20; position: absolute; bottom: 40px; text-transform: uppercase; letter-spacing: 2px; font-size: 10px;">Find the Panthère (0/3)</div>
</div>

<div class="game-level" id="level-3">
    <video id="v3-fullscreen" playsinline></video>
    
    <div class="l3-ui-overlay" id="l3-ui-container">
        <div class="input-display" id="l3-input">_</div>
        <div style="color: var(--white); letter-spacing: 2px; font-size: 10px;">TYPE: RED | WHITE | GOLD</div>
    </div>

    <div id="l3-choice-menu">
        <div style="color: var(--gold); margin-bottom: 25px; letter-spacing: 3px; font-size: 14px;">THE ODYSSEY CONTINUES</div>
        <button class="choice-btn" onclick="resetL3()">Another Color</button>
        <button class="choice-btn" onclick="nextLevel()">Game 4</button>
    </div>
</div>

<div class="game-level" id="level-4">
    <video id="v4" playsinline autoplay loop><source id="s4" src="standing.mp4" type="video/mp4"></video>
    <div id="pet-zone" onmousemove="handlePet(event)" ontouchmove="handlePet(event)"></div>
    <div class="purr-meter"><div id="purr-fill"></div></div>
    <div style="color: var(--gold); margin-top: 10px; letter-spacing: 2px; font-size: 10px;">Pet the Panthère</div>
</div>

<div class="game-level" id="level-5">
    <div id="puzzle-board"></div>
    <div class="puzzle-text" id="puzzle-status">Restore the Panthère</div>
</div>

<div id="end-page">
    <h1 style="color: var(--white); letter-spacing: 5px; font-size: 24px;">MASTERY ACHIEVED</h1>
    <button class="start-btn" style="border-color: white; color: white; margin-top: 20px;" onclick="location.reload()">Replay</button>
</div>

<script>
let currentLevel = 0;
let l2_finds = 0;
let pet_intensity = 0;
let puzzle_order = [0,1,2,3,4,5,6,7,8];
let selected_tile = null;
let isLevelTransitioning = false;
let runInterval;

function showStartButton() {
    document.getElementById('start-gate').style.display = 'none';
    document.getElementById('btn-gate').style.display = 'flex';
}

function nextLevel() {
    currentLevel++;
    isLevelTransitioning = false;
    document.getElementById('btn-gate').style.display = 'none';
    document.getElementById('hud').style.display = 'block';
    document.querySelectorAll('.game-level').forEach(l => l.classList.remove('active'));
    document.getElementById(`level-${currentLevel}`).classList.add('active');
    document.getElementById('lvl-num').innerText = currentLevel;

    if(currentLevel === 1) initL1();
    if(currentLevel === 2) startPantherRun();
    if(currentLevel === 5) initL5();
}

function initL1() {
    const c = document.getElementById('canvas-l1');
    const ctx = c.getContext('2d');
    c.width = window.innerWidth; c.height = window.innerHeight;
    ctx.fillStyle = '#801B2B'; 
    ctx.fillRect(0,0,c.width,c.height);
    ctx.globalCompositeOperation = 'destination-out';
    
    const scratch = (x, y) => {
        ctx.beginPath(); ctx.arc(x, y, 60, 0, Math.PI * 2); ctx.fill();
        document.getElementById('n1').style.display = 'block';
    };

    c.addEventListener('mousemove', (e) => scratch(e.clientX, e.clientY));
    c.addEventListener('touchmove', (e) => {
        const touch = e.touches[0];
        scratch(touch.clientX, touch.clientY);
    });
}

function startPantherRun() {
    document.getElementById('v2-container').style.display = 'block';
    movePanther();
    runInterval = setInterval(movePanther, 2000); 
}

function movePanther() {
    if(currentLevel !== 2) { clearInterval(runInterval); return; }
    const cont = document.getElementById('v2-container');
    const x = Math.random() * (window.innerWidth - 150) + 75;
    const y = Math.random() * (window.innerHeight - 150) + 75;
    cont.style.left = x + 'px';
    cont.style.top = y + 'px';
}

const updateSpotlight = (x, y) => {
    if(currentLevel === 2) {
        document.documentElement.style.setProperty('--x', x + 'px');
        document.documentElement.style.setProperty('--y', y + 'px');
        const cont = document.getElementById('v2-container');
        const rect = cont.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        const dist = Math.hypot(x - centerX, y - centerY);
        if (dist < 100) cont.style.filter = "brightness(1.5)";
        else cont.style.filter = "brightness(0)";
    }
};

window.addEventListener('mousemove', (e) => updateSpotlight(e.clientX, e.clientY));
window.addEventListener('touchmove', (e) => updateSpotlight(e.touches[0].clientX, e.touches[0].clientY));

function catchPanther() {
    const cont = document.getElementById('v2-container');
    if (parseFloat(getComputedStyle(cont).filter.replace('brightness(', '')) > 0) {
        l2_finds++;
        document.getElementById('l2-text').innerText = `Find the Panthère (Found: ${l2_finds}/3)`;
        if(l2_finds >= 3) {
            clearInterval(runInterval);
            setTimeout(nextLevel, 500);
        } else movePanther();
    }
}

let l3_buffer = "";
window.addEventListener('keydown', (e) => {
    if(currentLevel === 3 && !isLevelTransitioning) {
        if(e.key.length === 1 && e.key.match(/[a-z]/i)) {
            l3_buffer += e.key.toUpperCase();
            document.getElementById('l3-input').innerText = l3_buffer;
            let vid = "";
            if(l3_buffer.includes("RED")) vid = "redpaint.mp4";
            else if (l3_buffer.includes("WHITE")) vid = "whitepaint.mp4";
            else if (l3_buffer.includes("GOLD")) vid = "goldpaint.mp4";

            if(vid) {
                isLevelTransitioning = true;
                const v3 = document.getElementById('v3-fullscreen');
                document.getElementById('l3-ui-container').style.display = 'none';
                v3.style.display = 'block';
                v3.src = vid; v3.play();
                v3.onended = () => { document.getElementById('l3-choice-menu').style.display = 'flex'; };
            }
            if(l3_buffer.length > 8) l3_buffer = "";
        }
    }
});

function resetL3() {
    l3_buffer = ""; isLevelTransitioning = false;
    document.getElementById('l3-input').innerText = "_";
    document.getElementById('v3-fullscreen').style.display = 'none';
    document.getElementById('l3-choice-menu').style.display = 'none';
    document.getElementById('l3-ui-container').style.display = 'block';
}

function handlePet(e) {
    if(currentLevel !== 4 || isLevelTransitioning) return;
    pet_intensity += 1.5;
    document.getElementById('purr-fill').style.width = Math.min(pet_intensity, 100) + "%";
    if(pet_intensity >= 100) {
        isLevelTransitioning = true;
        const v = document.getElementById('v4');
        document.getElementById('s4').src = "purr.mp4";
        v.muted = false; v.loop = false; v.load(); v.play();
        v.onended = () => { nextLevel(); };
    }
}
setInterval(() => { if(pet_intensity > 0 && currentLevel === 4) pet_intensity -= 0.5; }, 100);

function initL5() { puzzle_order.sort(() => Math.random() - 0.5); renderPuzzle(); }
function renderPuzzle() {
    const board = document.getElementById('puzzle-board');
    board.innerHTML = '';
    puzzle_order.forEach((pos, slot) => {
        const tile = document.createElement('div');
        tile.className = 'tile';
        if(selected_tile === slot) tile.classList.add('selected');
        const v = document.createElement('video');
        v.setAttribute('playsinline', ''); // Essential for mobile
        v.src = 'standing.mp4'; v.autoplay = true; v.loop = true; v.muted = true;
        v.style.top = `-${Math.floor(pos / 3) * 100}%`; v.style.left = `-${(pos % 3) * 100}%`;
        tile.onclick = () => {
            if(selected_tile === null) { selected_tile = slot; renderPuzzle(); }
            else { 
                [puzzle_order[selected_tile], puzzle_order[slot]] = [puzzle_order[slot], puzzle_order[selected_tile]];
                selected_tile = null; renderPuzzle(); 
                if(puzzle_order.every((v,i)=>v===i)) {
                    document.getElementById('puzzle-status').innerText = "MAGNIFIQUE";
                    setTimeout(() => {
                        document.getElementById('hud').style.display = 'none';
                        document.getElementById('level-5').style.display = 'none';
                        document.getElementById('end-page').style.display = 'flex';
                    }, 3000);
                }
            }
        };
        tile.appendChild(v); board.appendChild(tile);
    });
}

// Ensure the game resizes correctly if orientation changes
window.onresize = () => {
    if(currentLevel === 1) initL1();
};
</script>
</body>
</html>
